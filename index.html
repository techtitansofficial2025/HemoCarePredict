<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HemoCare — Frontend (Custom API URL)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Poppins:wght@500&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Inter",system-ui,Arial;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .card{
      width:100%;max-width:720px;background:rgba(255,255,255,.98);border-radius:14px;padding:26px;
      box-shadow:0 18px 40px rgba(0,0,0,.12);
    }
    h1{font-family:"Poppins",sans-serif;margin-bottom:6px;font-size:24px}
    p.lead{color:#667; margin-bottom:18px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;font-weight:600;color:#2c3e50;margin-bottom:6px;font-size:14px}
    input[type="text"], input[type="number"], select {
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e9ef;background:#fbfcfe;font-size:15px;
    }
    input[type="text"]:focus,input[type="number"]:focus,select:focus{outline:none;box-shadow:0 6px 18px rgba(102,126,234,.08)}
    .controls{display:flex;gap:12px;margin-top:16px;align-items:center}
    button{
      background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px 18px;border:none;border-radius:10px;
      cursor:pointer;font-weight:700; font-size:15px;
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .result{
      margin-top:18px;padding:16px;border-radius:10px;display:none;font-weight:700;
    }
    .result.ok{background:linear-gradient(135deg,#00b894,#00cec9);color:white}
    .result.warn{background:linear-gradient(135deg,#ff7675,#fd79a8);color:white}
    .error{margin-top:12px;padding:12px;border-radius:10px;background:#ff7675;color:white;display:none}
    .small{font-size:13px;color:#556; margin-top:8px}
    .api-row{display:flex;gap:10px;align-items:center}
    .api-row input{flex:1}
    .notes{margin-top:14px;font-size:13px;color:#6b7280}
    .flex-between{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>HemoCare — Quick Predict</h1>
    <p class="lead">Enter measurements and your backend API URL (you can use a Render/Heroku/Colab endpoint). The form will POST JSON to that URL.</p>

    <div class="api-row">
      <label for="apiUrl" style="margin-right:12px;min-width:90px;">API URL</label>
      <input id="apiUrl" type="text" placeholder="https://hemocare-9t4e.onrender.com/api/predict/" value="" />
      <button id="testApiBtn" type="button">Test</button>
    </div>
    <div class="small">Tip: include the full path (e.g. <code>/api/predict/</code>) and start with <code>https://</code>.</div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eef2f7">

    <form id="predictForm">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label for="red">Red light absorption (a.u.)</label>
          <input id="red" name="red" type="number" step="0.01" required />
        </div>
        <div>
          <label for="ir">Infrared absorption (a.u.)</label>
          <input id="ir" name="ir" type="number" step="0.01" required />
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <label for="gender">Gender</label>
          <select id="gender" name="gender" required>
            <option value="">Select</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div>
          <label for="age">Age (years)</label>
          <input id="age" name="age" type="number" min="0" max="130" required />
        </div>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">Predict</button>
        <div style="margin-left:auto" id="statusText" class="small"></div>
      </div>
    </form>

    <div id="resultBox" class="result"></div>
    <div id="errorBox" class="error"></div>

    <div class="flex-between notes">
      <div>Response expects JSON with <code>predicted_hb</code> (numeric) or similar keys.</div>
      <div style="font-size:12px;color:#9aa">WHO-ish cutoffs used: female &lt; 12 g/dL, male &lt; 13 g/dL</div>
    </div>
  </div>

  <script>
    const apiInput = document.getElementById('apiUrl');
    const testBtn = document.getElementById('testApiBtn');
    const form = document.getElementById('predictForm');
    const resultBox = document.getElementById('resultBox');
    const errorBox = document.getElementById('errorBox');
    const submitBtn = document.getElementById('submitBtn');
    const statusText = document.getElementById('statusText');

    // Optional: remember last used API in localStorage
    apiInput.value = localStorage.getItem('hc_api') || '';

    testBtn.addEventListener('click', async () => {
      const url = apiInput.value.trim();
      clearMessages();
      if (!url) { showError('Enter API URL first'); return; }
      try {
        statusText.textContent = 'Testing...';
        // run a lightweight OPTIONS or GET to check availability (some APIs don't allow GET)
        const resp = await fetch(url, { method: 'OPTIONS' });
        statusText.textContent = `Status: ${resp.status} ${resp.statusText}`;
        localStorage.setItem('hc_api', url);
      } catch (err) {
        statusText.textContent = '';
        showError('API test failed — cross-origin or server error. Try full URL ending with /predict/ or use the server domain and check CORS.');
        console.error(err);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      const url = apiInput.value.trim();
      if (!url) { showError('Please provide the backend API URL.'); return; }

      const payload = {
        red: parseFloat(document.getElementById('red').value),
        ir: parseFloat(document.getElementById('ir').value),
        gender: document.getElementById('gender').value,
        age: parseFloat(document.getElementById('age').value)
      };

      // basic validation
      if (isNaN(payload.red) || isNaN(payload.ir) || !payload.gender || isNaN(payload.age)) {
        showError('Please fill all fields with valid values.');
        return;
      }

      submitBtn.disabled = true;
      statusText.textContent = 'Sending...';

      try {
        // Save used URL
        localStorage.setItem('hc_api', url);

        const resp = await fetch(url, {
          method: 'POST',
          mode: 'cors', // depends on backend CORS settings
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          // read text if available for debugging
          let text = await resp.text().catch(()=>null);
          throw new Error(`Server returned ${resp.status}${text ? ': '+text : ''}`);
        }

        const data = await resp.json().catch(()=>null);
        if (!data) throw new Error('Server returned non-JSON response');

        // figure out numeric Hb from common keys
        const hb = firstNumeric(data, ['predicted_hb','predicted','hb','hemoglobin','prediction','result_hb']);
        if (hb === null) {
          // sometimes server wraps result: { predicted_hb: { value: 12.3 } }
          // flatten values and try
          const flattened = JSON.stringify(data);
          throw new Error('No numeric predicted_hb found in JSON. Response: ' + flattened);
        }

        // Determine anemia risk by gender (simple rule-of-thumb)
        const gender = (payload.gender||'').toLowerCase();
        const femaleCut = 12.0, maleCut = 13.0;
        const isAnemia = (gender === 'female' && hb < femaleCut) || (gender === 'male' && hb < maleCut);

        resultBox.style.display = 'block';
        resultBox.className = 'result ' + (isAnemia ? 'warn' : 'ok');
        resultBox.innerHTML = `<div>Predicted Hb: <strong>${hb.toFixed(2)} g/dL</strong></div>
                               <div style="font-weight:600;margin-top:6px">${isAnemia ? 'Anemia risk detected — consult a healthcare professional.' : 'Low anemia risk'}</div>`;

      } catch (err) {
        console.error(err);
        showError(err.message || 'Unknown error when calling backend');
      } finally {
        submitBtn.disabled = false;
        statusText.textContent = '';
      }
    });

    function firstNumeric(obj, keys){
      for(const k of keys){
        if (k in obj){
          const val = obj[k];
          const n = Number(val);
          if (!Number.isNaN(n)) return n;
          // if nested like {predicted_hb: {value:12.3}}
          if (val && typeof val === 'object') {
            // try find numeric inside
            for(const kk in val){
              const n2 = Number(val[kk]);
              if (!Number.isNaN(n2)) return n2;
            }
          }
        }
      }
      // fallback: search all top-level values for numeric
      for(const k in obj){
        const n = Number(obj[k]);
        if (!Number.isNaN(n)) return n;
      }
      return null;
    }

    function showError(msg){
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }
    function clearMessages(){
      resultBox.style.display = 'none';
      resultBox.textContent = '';
      errorBox.style.display = 'none';
      errorBox.textContent = '';
      statusText.textContent = '';
    }
  </script>
</body>
</html>
